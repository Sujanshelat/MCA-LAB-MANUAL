


.INCLUDE "M32DEF.INC"
.EQU PORT=PORTC
.EQU PIN=PINC
.EQU DDR=DDRC

LDI R20,HIGH(RAMEND)
OUT SPH,R20
LDI R20,LOW(RAMEND)
OUT SPL,R20

LDI R21,0xFF
OUT DDRD,R21
LDI R20,0xF0
OUT DDRC,R20

GROUND_ALL_ROWS:
LDI R20,0x0F
OUT PORT,R20
WAIT_FOR_RELEASE:
NOP IN R21,PINC
ANDI R21,0X0F
CPI R21,0X0F
BRNE WAIT_FOR_RELEASE
WAIT_FOR_KEY:
NOP
IN R21,PINC
ANDI R21,0X0F
CPI R21,0X0F
BREQ WAIT_FOR_KEY
CALL WAIT15MS
IN R21,PINC
ANDI R21,0X0F
CPI R21,0x0F
BREQ WAIT_FOR_KEY
LDI R21,0B01111111
OUT PORT,R21
NOP 
IN R21,PINC
ANDI R21,0X0F
CPI R21,0x0F
BRNE COL1
LDI R21,0B10111111
OUT PORT,R21
NOP 
IN R21,PINC
ANDI R21,0X0F
CPI R21,0x0F
BRNE COL2
LDI R21,0B11011111
OUT PORT,R21
NOP
IN R21,PINC
ANDI R21,0X0F
CPI R21,0x0F
BRNE COL3
LDI R21,0B11101111
OUT PORT,R21
NOP
IN R21,PINC
ANDI R21,0X0F
CPI R21,0x0F
BRNE COL4
COL1:
LDI R30,LOW(KCODE0<<1)
LDI R31,HIGH(KCODE0<<1)
RJMP FIND
COL2:
LDI R30,LOW(KCODE0<<1)
LDI R31,HIGH(KCODE0<<1)
RJMP FIND
COL3:
LDI R30,LOW(KCODE0<<1)
LDI R31,HIGH(KCODE0<<1)
RJMP FIND
COL4:
LDI R30,LOW(KCODE0<<1)
LDI R31,HIGH(KCODE0<<1)
RJMP FIND
FIND:
LSR R21
BRCC MATCH
LPM R20,Z+
RJMP FIND
MATCH:
LPM R20,Z
OUT PORTD,R20
RJMP GROUND_ALL_ROWS
WAIT15MS:
RET

.ORG 0X300 
KCODE0: .DB '0','1','2','3' ;ROW0
KCODE1: .DB '4','5','6','7' ;ROW1
KCODE2: .DB '8','9','A','B' ;ROW2
KCODE3: .DB 'C','D','E','F' ;ROW3


 

